#!/bin/bash

# Simple test runner for CI/CD or quick testing
# This script provides a minimal interface for automated testing

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors (only if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    NC=''
fi

# Quick test function
quick_test() {
    echo -e "${YELLOW}goto クイックテスト実行中...${NC}"
    
    # Build the binary
    echo "1. ビルドテスト..."
    cd "$PROJECT_DIR/go"
    if go build -o goto; then
        echo -e "${GREEN}✅ ビルド成功${NC}"
    else
        echo -e "${RED}❌ ビルド失敗${NC}"
        return 1
    fi
    
    # Basic functionality test
    echo "2. 基本機能テスト..."
    if ./goto -h > /dev/null 2>&1; then
        echo -e "${GREEN}✅ ヘルプ表示成功${NC}"
    else
        echo -e "${RED}❌ ヘルプ表示失敗${NC}"
        return 1
    fi
    
    if ./goto -v > /dev/null 2>&1; then
        echo -e "${GREEN}✅ バージョン表示成功${NC}"
    else
        echo -e "${RED}❌ バージョン表示失敗${NC}"
        return 1
    fi
    
    if ./goto --complete > /dev/null 2>&1; then
        echo -e "${GREEN}✅ 補完機能成功${NC}"
    else
        echo -e "${GREEN}✅ 補完機能成功（設定なし）${NC}"
    fi
    
    echo -e "${GREEN}✅ すべてのクイックテストが成功しました${NC}"
    return 0
}

# Show usage
show_usage() {
    echo "使用方法: $0 [オプション]"
    echo
    echo "オプション:"
    echo "  quick, -q           クイックテストのみ実行"
    echo "  full, -f            すべてのテストを実行"
    echo "  basic               基本機能テストのみ実行"
    echo "  functional          機能テストのみ実行"
    echo "  performance         パフォーマンステストのみ実行"
    echo "  -h, --help          このヘルプメッセージを表示"
    echo
    echo "デフォルト（引数なし）: クイックテストを実行"
}

# Main function
main() {
    case "${1:-quick}" in
        quick|-q|"")
            quick_test
            ;;
        full|-f)
            exec "$SCRIPT_DIR/run_tests.sh"
            ;;
        basic)
            exec "$SCRIPT_DIR/run_tests.sh" --basic-only
            ;;
        functional)
            exec "$SCRIPT_DIR/run_tests.sh" --functional-only
            ;;
        performance)
            exec "$SCRIPT_DIR/run_tests.sh" --performance-only
            ;;
        -h|--help|help)
            show_usage
            ;;
        *)
            echo -e "${RED}エラー: 不明なオプション '$1'${NC}"
            show_usage
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
